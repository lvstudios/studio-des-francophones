<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Le Studio des Francophones</title>
<style>
  body{font-family:Inter, Arial, sans-serif;background:#071422;color:#e6eef4;margin:0;padding:20px}
  header{display:flex;gap:16px;align-items:center}
  .logo{width:64px;height:64px;border-radius:10px;background:linear-gradient(135deg,#0ea5a4,#06b6d4);display:flex;align-items:center;justify-content:center;font-weight:700}
  h1{margin:0}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:18px;margin-top:20px}
  .card{background:rgba(255,255,255,0.03);padding:12px;border-radius:10px}
  .thumb{width:100%;height:180px;object-fit:cover;border-radius:8px;box-shadow:0 8px 20px rgba(0,0,0,0.6)}
  .meta{margin-top:8px;display:flex;justify-content:space-between;align-items:center}
  .btn{padding:6px 10px;border-radius:8px;border:none;background:#0ea5a4;color:#022;cursor:pointer}
  footer{margin-top:28px;color:rgba(230,238,244,0.65)}
  .iframe-wrap{width:100%;height:402px;border:0}
</style>
</head>
<body>
<header>
  <div class="logo">SF</div>
  <div>
    <h1>Le Studio des Francophones</h1>
    <div>Studio Scratch réservé aux parlants français — projets récents automatiquement importés depuis la page du studio.</div>
  </div>
</header>

<main>
  <section style="margin-top:18px">
    <button class="btn" id="refreshBtn">Mettre à jour maintenant</button>
    <span id="status" style="margin-left:12px;color:rgba(230,238,244,0.75)"></span>
  </section>

  <section class="grid" id="projectsGrid" aria-live="polite"></section>
</main>

<footer>
  © Le Studio des Francophones — créé pour toi, Louis.
</footer>

<script>
const projectsGrid = document.getElementById('projectsGrid');
const status = document.getElementById('status');
const refreshBtn = document.getElementById('refreshBtn');

async function loadProjects() {
  status.textContent = 'Chargement...';
  try {
    const res = await fetch('/projects.json', {cache: 'no-store'});
    if(!res.ok) throw new Error('projects.json introuvable');
    const projects = await res.json();
    renderProjects(projects);
    status.textContent = `${projects.length} projets affichés`;
  } catch (e) {
    projectsGrid.innerHTML = '<div style="color:#f88">Impossible de charger les projets. Lance /update-studio sur le serveur.</div>';
    status.textContent = 'Erreur';
    console.error(e);
  }
}

function renderProjects(list) {
  if(!list || list.length===0) { projectsGrid.innerHTML = '<div>Aucun projet trouvé.</div>'; return; }
  projectsGrid.innerHTML = '';
  list.forEach(p => {
    const el = document.createElement('article');
    el.className = 'card';
    el.innerHTML = `
      <div style="font-weight:700">${escapeHtml(p.title)}</div>
      <div style="font-size:13px;color:rgba(230,238,244,0.7)">par ${escapeHtml(p.author)}</div>
      ${p.thumbnail ? `<img class="thumb" src="${p.thumbnail}" alt="${escapeHtml(p.title)}">` : ''}
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <button class="btn" onclick="openEmbed(${p.id})">Voir (embed)</button>
        <a class="btn" style="text-decoration:none" href="${p.url}" target="_blank" rel="noopener">Page Scratch</a>
      </div>
    `;
    projectsGrid.appendChild(el);
  });
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'}[c])); }

function openEmbed(id){
  // on remplace la grille par l'iframe du projet pour le voir
  projectsGrid.innerHTML = `
    <div class="card">
      <div style="margin-bottom:8px"><button class="btn" onclick="loadProjects()">Retour</button></div>
      <iframe class="iframe-wrap" src="https://scratch.mit.edu/projects/${id}/embed" allowtransparency="true" frameborder="0" scrolling="no" allowfullscreen></iframe>
    </div>
  `;
}

// bouton forcer mise à jour (appelle le serveur)
refreshBtn.addEventListener('click', async ()=>{
  status.textContent = 'Mise à jour en cours...';
  try {
    const r = await fetch('/update-studio');
    const j = await r.json();
    if(j.ok) {
      await loadProjects();
      status.textContent = `Mis à jour: ${j.projects} projets`;
    } else {
      status.textContent = 'Échec mise à jour';
      console.error(j);
    }
  } catch(e) {
    status.textContent = 'Erreur lors de la mise à jour';
    console.error(e);
  }
});

// load at start
loadProjects();
</script>
</body>
</html>
